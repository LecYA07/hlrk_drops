# Twitch Drops бот + Telegram (Python + SQLite)

## Что это

Сервис запускает одновременно:
- Twitch-бота, который собирает активных зрителей из чата и проводит дропы.
- Telegram-бота, который даёт «админку», профиль участника, привязку Twitch и уведомления.

## Установка

1) Установи зависимости:

```bash
pip install -r requirements.txt
```

2) Заполни `config.yaml`:

- `twitch.bot_token` — токен чата Twitch в формате `oauth:...` (берётся на https://twitchapps.com/tmi/)
- `twitch.client_id` и `twitch.client_secret` — данные приложения Twitch (https://dev.twitch.tv/console)
- `telegram.bot_token` — токен Telegram-бота от @BotFather
- `telegram.admin_ids` — список Telegram ID админов

3) Запусти:

```bash
python main.py
```

Логи пишутся в консоль и в `bot.log`.

## Награды (дропы)

Награды лежат в SQLite (по умолчанию `rewards.db`) в таблице `rewards`.

### Как добавить награду

Команда:

```bash
python manage_rewards.py add_reward "Название" "Описание" ВЕС --quantity КОЛИЧЕСТВО
```

Примеры:

1) Частая награда (вес 100), 1 победитель:

```bash
python manage_rewards.py add_reward "Обычный дроп" "Что-то простое" 100 --quantity 1
```

2) Редкая награда (вес 10), 5 победителей за раз:

```bash
python manage_rewards.py add_reward "Редкий дроп" "Что-то ценное" 10 --quantity 5
```

### Шанс (вес)

Бот выбирает **ОДНУ** награду из включённых (`enabled=1`) взвешенно по `weight`.

Если включено 3 награды с весами 50 / 10 / 140, то суммарный вес = 200.

- шанс первой: 50/200 = 25%
- шанс второй: 10/200 = 5%
- шанс третьей: 140/200 = 70%

### Сколько победителей за раз (quantity)

После выбора награды бот выбирает `quantity` победителей из активных.

- если активных меньше, чем `quantity`, выигрывают все активные

### Посмотреть список наград

```bash
python manage_rewards.py list_rewards
```

### Включить/выключить награду

```bash
python manage_rewards.py toggle_reward ID
```

## Как работает розыгрыш

1) Бот следит за онлайном канала.
2) Пока стрим онлайн — раз в случайный интервал `min_interval_minutes..max_interval_minutes` запускает розыгрыш.
3) Победителям пишется сообщение в чат:

«вы выиграли … напишите любое сообщение в чат за 7 минут, чтобы забрать награду».

4) Если победитель написал любое сообщение в чат в течение `claim_timeout_minutes` — награда подтверждается (`claimed`).
5) Если не написал — награда сгорает (`expired`).

## Telegram-бот

### Инлайн-меню

В Telegram всё управление через кнопки:
- **Профиль** — показывает привязанный Twitch и статистику.
- **Привязать Twitch** — выдаёт код.
- **Админ-панель** (только для `admin_ids`) — статистика и подсказка по рассылке.

### Привязка Twitch к Telegram

1) В Telegram нажми «Привязать Twitch» и получи код.
2) В чате Twitch напиши:

```text
!link КОД
```

После этого Telegram и Twitch будут связаны.

### Уведомления

- О старте стрима: всем привязанным пользователям приходит сообщение.
- О конце стрима: приходит сводка «что ты получил за стрим» (по подтверждённым наградам).
- При подтверждении награды (когда написал в чат вовремя) — приходит сообщение.
- Если награда сгорела — тоже приходит сообщение.

### Админ-команды

- `/broadcast ТЕКСТ` — рассылка всем пользователям, у кого привязан Twitch.

## Важно про безопасность

Не храни реальные токены в репозитории. В `config.yaml` оставлены плейсхолдеры — вставь свои значения локально.

